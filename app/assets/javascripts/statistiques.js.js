// Generated by CoffeeScript 1.2.1-pre
(function() {

  $(document).ready(function() {
    var statisitques;
    statisitques = {
      user_id: $('#id_user_stats').val(),
      init: function() {
        $('.page-header').tooltip({
          'trigger': 'hover',
          'placement': 'left'
        });
        statisitques.data_month();
        return statisitques.data_year();
      },
      data_month: function() {
        return $.ajax({
          type: "POST",
          url: "/administration/users/" + statisitques.user_id + "/ca_by_month",
          async: false,
          format: "json",
          success: function(data) {
            var data_pie, infos;
            infos = data;
            data_pie = [infos.CA_product_ttc, infos.CA_abonnement_ttc];
            return statisitques.create_pie(data_pie);
          }
        });
      },
      data_year: function() {
        return $.ajax({
          type: "POST",
          url: "/administration/users/" + statisitques.user_id + "/ca_by_year",
          async: false,
          format: "json",
          success: function(data) {
            var data_graph, infos, nb_month, nb_month_format;
            infos = data;
            nb_month = 1;
            data_graph = [];
            while (nb_month <= 12) {
              if (nb_month < 10) {
                nb_month_format = '0' + nb_month;
              } else {
                nb_month_format = nb_month;
              }
              data_graph.push({
                q: '2012-' + nb_month_format,
                a: infos['CA_increment'][nb_month]['CA_product_ttc'],
                b: infos['CA_increment'][nb_month]['CA_abonnement_ttc']
              });
              nb_month++;
            }
            return statisitques.create_graph(data_graph);
          }
        });
      },
      create_pie: function(data) {
        var camembert, r;
        r = Raphael('camembert');
        camembert = r.piechart(320, 240, 100, data, {
          legend: ["%%.%% - " + data[0] + " €", "%%.%% - " + data[1] + " €"],
          legendpos: "est",
          colors: ["#59a494", "#ea9d6e"]
        });
        $('#camembert path').css("box-shadow", "1px 1px 1px solid black");
        r.text(320, 100, "Chiffre d'affaire du mois").attr({
          font: "20px sans-serif"
        });
        return camembert.hover(function() {
          this.sector.stop();
          this.sector.scale(1.1, 1.1, this.cx, this.cy);
          if (this.label) {
            this.label[0].stop();
            this.label[0].attr({
              r: 7.5
            });
            return this.label[1].attr({
              "font-weight": 800
            });
          }
        }, function() {
          this.sector.animate({
            transform: 's1 1 ' + this.cx + ' ' + this.cy
          }, 500, "bounce");
          if (this.label) {
            this.label[0].animate({
              r: 5
            }, 500, "bounce");
            return this.label[1].attr({
              "font-weight": 400
            });
          }
        });
      },
      create_graph: function(data_) {
        console.log(data_);
        return Morris.Line({
          element: 'graph',
          data: data_,
          xkey: 'q',
          ykeys: ['a', 'b'],
          labels: ['CA produit', 'CA abonnement'],
          lineColors: ['#59a494', '#ea9d6e'],
          lineWidth: 2,
          smooth: false,
          pointSize: 3,
          hideHover: true,
          xLabels: "month",
          xLabelFormat: function(x) {
            switch (x.getMonth()) {
              case 0:
                return 'Jan.';
              case 1:
                return 'Fév.';
              case 2:
                return 'Ma.';
              case 3:
                return 'Av.';
              case 4:
                return 'Mai';
              case 5:
                return 'Juin';
              case 6:
                return 'Juil.';
              case 7:
                return 'Aout';
              case 8:
                return 'Sep.';
              case 9:
                return 'Oct.';
              case 10:
                return 'Nov.';
              case 11:
                return 'Déc.';
            }
          }
        });
      }
    };
    return statisitques.init();
  });

}).call(this);
