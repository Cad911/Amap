// Generated by CoffeeScript 1.2.1-pre
(function() {

  $(document).ready(function() {
    var evenement_button, evenement_form, exist_deja, id_user, info_stock, initialisation_ajout, next_step, previous_id, previous_step, produit_deja_envente, quantite_stock, text_previous, verif_all_input, verif_one_input, verif_quantite;
    id_user = $('#produit_vente_libre_id_user_input').val();
    exist_deja = false;
    previous_id = "";
    info_stock = function(stock_id) {
      $.ajax("/administration/users/" + id_user + "/stocks/" + stock_id, {
        type: "GET",
        async: false,
        format: "json",
        success: function(data) {
          $('#produit_vente_libre_titre').val(data[0]["titre"]);
          $('#produit_vente_libre_description').val(data[0]["description"]);
          $('#quantite_stock').text(data[0]["quantite"]);
          $('#unite_mesure_stock').text(data[1]["abbreviation"]);
          return false;
        }
      });
      return true;
    };
    quantite_stock = function(stock_id) {
      var quantite_stock_return;
      quantite_stock_return = 0;
      $.ajax("/administration/users/" + id_user + "/stocks/" + stock_id, {
        type: "GET",
        async: false,
        format: "json",
        success: function(data) {
          return quantite_stock_return = parseInt(data[0]["quantite"]);
        }
      });
      return quantite_stock_return;
    };
    verif_quantite = function() {
      var nombre_pack, quantite_mise_en_ligne, quantite_stock_v, resultat_reste;
      if (!isNaN(parseInt($('#produit_vente_libre_quantite').val())) && !isNaN(parseInt($('#produit_vente_libre_nombre_pack').val()))) {
        quantite_mise_en_ligne = parseInt($('#produit_vente_libre_quantite').val());
        nombre_pack = parseInt($('#produit_vente_libre_nombre_pack').val());
        quantite_stock_v = quantite_stock($('#produit_vente_libre_stock_id').val());
        resultat_reste = quantite_stock_v - (nombre_pack * quantite_mise_en_ligne);
        console.log(resultat_reste);
        if (resultat_reste < 0) {
          if (!$('div').hasClass('error_quantite')) {
            $('.alert-info').after('<div style="display:none;" class="alert alert-error error_quantite"> <a class="close" data-dismiss="alert"> x </a> <strong>Erreur </strong> La quantite mis en ligne excede celle du stock </div>');
            $('.error_quantite').slideDown('2000');
            setTimeout(function() {
              return $('.error_quantite').slideUp('2000', function() {
                return $('.error_quantite').remove();
              });
            }, 5000);
            return true;
          }
        } else {
          if (!$('div').hasClass('info_reste_quantite')) {
            $('.alert-info').after('<div style="display:none;" class="alert alert-success info_reste_quantite"> <a class="close" data-dismiss="alert"> x </a> <strong>Infos </strong> Il vous restera ' + resultat_reste + ' ' + $("#unite_mesure_stock").text() + ' dans votre stock </div>');
            $('.info_reste_quantite').slideDown('2000');
          } else {
            $('.info_reste_quantite').html(' <a class="close" data-dismiss="alert"> x </a> <strong>Infos </strong> Il vous restera ' + resultat_reste + ' ' + $("#unite_mesure_stock").text() + ' dans votre stock ');
          }
          return false;
        }
      } else {
        return false;
      }
    };
    produit_deja_envente = function(id_produit) {
      $.ajax("/administration/users/" + id_user + "/exist_vente/" + id_produit, {
        type: "GET",
        async: false,
        format: "json",
        success: function(data) {
          exist_deja = data;
          return true;
        }
      });
      return exist_deja;
    };
    verif_all_input = function() {
      var erreur, erreur_quantite;
      erreur = false;
      erreur_quantite = false;
      $('.etape_active input').each(function() {
        if ($(this).attr('type') === "number") {
          if ($(this).val() === "") {
            $(this).parent().parent().addClass('error');
            $(this).next().remove();
            $(this).after('<span class="help-inline">Ne peut pas être vide</span>');
            return erreur = true;
          } else if (isNaN(parseInt($(this).val()))) {
            $(this).parent().parent().addClass('error');
            $(this).next().remove();
            $(this).after('<span class="help-inline"> Ce n\'est pas un nombre</span>');
            return erreur = true;
          } else {
            $(this).parent().parent().removeClass('warning');
            return $(this).next().remove();
          }
        }
      });
      if (erreur === true) {
        if (!$('div').hasClass('all_error')) {
          $('.form-inputs').append('<div style="display:none;" class="alert alert-error all_error"> <a class="close" data-dismiss="alert"> x </a> <strong>Erreur </strong> Corrigé vos erreurs </div>');
        }
        $('.all_error').slideDown('2000');
        setTimeout(function() {
          return $('.all_error').slideUp('2000', function() {
            return $('.all_error').remove();
          });
        }, 3000);
      }
      return erreur;
    };
    verif_one_input = function(id_input) {
      var erreur_quantite;
      erreur_quantite = false;
      if ($(id_input).attr('type') === "number") {
        if ($(id_input).val() === "") {
          $(id_input).parent().parent().removeClass('success');
          $(id_input).parent().parent().addClass('warning');
          $(id_input).next().remove();
          return $(id_input).after('<span class="help-inline">Ne peut pas être vide</span>');
        } else if (isNaN(parseInt($(id_input).val()))) {
          $(id_input).parent().parent().removeClass('success');
          $(id_input).parent().parent().addClass('warning');
          $(id_input).next().remove();
          return $(id_input).after('<span class="help-inline"> Ce n\'est pas un nombre</span>');
        } else {
          $(id_input).parent().parent().addClass('success');
          $(id_input).parent().parent().removeClass('error');
          $(id_input).parent().parent().removeClass('warning');
          return $(id_input).next().remove();
        }
      }
    };
    next_step = function() {
      var class_div, class_next, i, _i;
      for (i = _i = 0; _i <= 5; i = ++_i) {
        if ($('.etape_active').hasClass('etape_' + i)) {
          class_div = 'etape_' + i;
          console.log(class_div);
          if ($('.etape_formulaire').hasClass('etape_' + (i + 1))) {
            class_next = 'etape_' + (i + 1);
          }
        }
      }
      $('.' + class_div).slideUp('5000');
      $('.' + class_next).slideDown('5000');
      $('.' + class_next).addClass('etape_active');
      return $('.' + class_div).removeClass('etape_active');
    };
    previous_step = function() {
      var class_div, class_previous, i, _i;
      for (i = _i = 0; _i <= 5; i = ++_i) {
        if ($('.etape_active').hasClass('etape_' + i)) {
          class_div = 'etape_' + i;
          console.log(class_div);
          if ($('.etape_formulaire').hasClass('etape_' + (i - 1))) {
            class_previous = 'etape_' + (i - 1);
          }
        }
      }
      $('.' + class_div).slideUp('5000');
      $('.' + class_previous).slideDown('5000');
      $('.' + class_previous).addClass('etape_active');
      return $('.' + class_div).removeClass('etape_active');
    };
    text_previous = "";
    evenement_form = function() {
      $('#produit_vente_libre_stock_id').focus(function() {
        return previous_id = $(this).val();
      }).change(function() {
        text_previous = $('#produit_vente_libre_stock_id option:selected').text();
        if (produit_deja_envente($(this).val())) {
          $(this).val(previous_id);
          $(this).parent().parent().prepend('<div style="display:none;" class="alert alert-error"> <a class="close" data-dismiss="alert"> x </a> <strong>Erreur </strong>' + text_previous + ' est déjà en vente </div>');
          return $('.alert-error').slideDown('2000');
        } else {
          return info_stock($(this).val());
        }
      });
      $('.etape_3 input').change(function() {
        var inputid;
        inputid = '#' + $(this).attr('id');
        return verif_one_input(inputid);
      });
      $('#produit_vente_libre_quantite,#produit_vente_libre_nombre_pack').change(function() {
        return verif_quantite();
      });
      $('#new_produit_vente_libre').submit(function() {
        var all_input, quantite_good;
        all_input = verif_all_input();
        quantite_good = verif_quantite();
        if (all_input || quantite_good) {
          return false;
        } else {
          return true;
        }
      });
      $('.form-actions .next').click(function() {
        return next_step();
      });
      $('.form-actions .previous').click(function() {
        return previous_step();
      });
      $('.simple_form').bind("ajax:loading", function(et, e) {
        alert(e);
        return $('#light_box').html('<div class="progress progress-striped"> <div class="bar" style="width:20%"> </div></div>');
      });
      return $('.simple_form').bind("ajax:complete", function(et, e) {
        return $('#light_box').modal('hide');
      });
    };
    evenement_button = function() {
      return $('.button-add').bind("ajax:complete", function(et, e) {
        $('#light_box').html(e.responseText);
        id_user = $('#produit_vente_libre_id_user_input').val();
        if (initialisation_ajout()) {
          if ($('.alert-error').length === 0) {
            $(this).after('<div style="display:none;" class="alert alert-error"> <a class="close" data-dismiss="alert"> x </a> <strong>Erreur </strong> Tous les produits du stock sont déjà en vente </div>');
            $('.alert-error').slideDown('2000');
            return setTimeout(function() {
              return $('.alert-error').slideUp('2000', function() {
                return $('.alert-error').remove();
              });
            }, 3000);
          }
        } else {
          evenement_form();
          return $('#light_box').modal('show');
        }
      });
    };
    initialisation_ajout = function() {
      var dem_produit_envente;
      info_stock($('#produit_vente_libre_stock_id').val());
      if (produit_deja_envente($('#produit_vente_libre_stock_id').val())) {
        dem_produit_envente = false;
        $('#produit_vente_libre_stock_id option').each(function() {
          var value_option;
          value_option = $(this).attr("value");
          if (!produit_deja_envente(value_option)) {
            dem_produit_envente = true;
            $('#produit_vente_libre_stock_id').val(value_option);
            return info_stock(value_option);
          }
        });
        if (!dem_produit_envente) return true;
      }
    };
    return evenement_button();
  });

}).call(this);
