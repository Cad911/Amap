module("wysihtml5.dom.Sandbox",{teardown:function(){var e;while(e=document.querySelector("iframe.wysihtml5-sandbox"))e.parentNode.removeChild(e)},getCharset:function(e){var t=e.characterSet||e.charset;return/unicode|utf-8/.test(t)?"utf-8":t},eval:function(e,t){try{return e.execScript?e.execScript(t):e.eval(t)}catch(n){return null}},isUnset:function(e,t){var n=this.eval(t,e);return!n||n==wysihtml5.EMPTY_FUNCTION}}),asyncTest("Basic Test",function(){expect(8);var e=new wysihtml5.dom.Sandbox(function(t){equal(t,e,"The parameter passed into the readyCallback is the sandbox instance");var n=document.querySelectorAll("iframe.wysihtml5-sandbox");equal(n.length,1,"iFrame sandbox inserted into dom tree");var r=n[n.length-1],i=r.width==0&&r.height==0&&r.frameBorder==0;ok(i,"iframe is not visible");var s=r.getAttribute("security")=="restricted";ok(s,"iFrame is sandboxed");var o=e.getWindow().setInterval&&e.getWindow().clearInterval;ok(o,"wysihtml5.Sandbox.prototype.getWindow() works properly");var u=e.getDocument().appendChild&&e.getDocument().body;ok(u,"wysihtml5.Sandbox.prototype.getDocument() works properly"),equal(e.getIframe(),r,"wysihtml5.Sandbox.prototype.getIframe() returns the iframe correctly"),equal(typeof e.getWindow().onerror,"function","window.onerror is set"),start()});e.insertInto(document.body)}),asyncTest("Security test #1",function(){expect(14);var e=this,t=new wysihtml5.dom.Sandbox(function(){var n=t.getWindow(),r=wysihtml5.browser.USER_AGENT.indexOf("Safari")!==-1&&wysihtml5.browser.USER_AGENT.indexOf("Chrome")===1;r?ok(!0,"Cookie is NOT unset (but that's expected in Safari)"):ok(e.isUnset("document.cookie",n),"Cookie is unset"),ok(e.isUnset("document.open",n),"document.open is unset"),ok(e.isUnset("document.write",n),"document.write is unset"),ok(e.isUnset("window.parent",n),"window.parent is unset"),ok(e.isUnset("window.opener",n),"window.opener is unset"),ok(e.isUnset("window.localStorage",n),"localStorage is unset"),ok(e.isUnset("window.globalStorage",n),"globalStorage is unset"),ok(e.isUnset("window.XMLHttpRequest",n),"XMLHttpRequest is an empty function"),ok(e.isUnset("window.XDomainRequest",n),"XDomainRequest is an empty function"),ok(e.isUnset("window.alert",n),"alert is an empty function"),ok(e.isUnset("window.prompt",n),"prompt is an empty function"),ok(e.isUnset("window.openDatabase",n),"window.openDatabase is unset"),ok(e.isUnset("window.indexedDB",n),"window.indexedDB is unset"),ok(e.isUnset("window.postMessage",n),"window.openDatabase is unset"),start()});t.insertInto(document.body)}),asyncTest("Security test #2",function(){expect(2);var e=new wysihtml5.dom.Sandbox(function(){var t='<img src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" onerror="#{script}" onload="try { window.parent._hackedCookie=document.cookie; } catch(e){}; try { window.parent._hackedVariable=1; } catch(e) {}">';e.getDocument().body.innerHTML=t,setTimeout(function(){equal(window._hackedCookie||"","","Cookie can't be easily stolen"),equal(window._hackedVariable||0,0,"iFrame has no access to parent"),start()},2e3)});e.insertInto(document.body)}),asyncTest("Check charset & doctype",function(){expect(3);var e=this,t=new wysihtml5.dom.Sandbox(function(){var n=t.getDocument(),r=n.compatMode=="BackCompat";ok(!r,"iFrame isn't in quirks mode"),equal(e.getCharset(n),e.getCharset(document),"Charset correctly inherited by iframe"),n.body.innerHTML='<meta charset="iso-8859-1">&uuml;',setTimeout(function(){equal(e.getCharset(n),e.getCharset(document),"Charset isn't overwritten"),start()},500)});t.insertInto(document.body)}),asyncTest("Check insertion of single stylesheet",function(){expect(1),(new wysihtml5.dom.Sandbox(function(e){var t=e.getDocument();equal(t.getElementsByTagName("link").length,1,"Correct amount of stylesheets inserted into the dom tree"),start()},{stylesheets:"https://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/themes/blitzer/jquery-ui.css"})).insertInto(document.body)}),asyncTest("Check insertion of multiple stylesheets",function(){expect(1),(new wysihtml5.dom.Sandbox(function(e){var t=e.getDocument();equal(t.getElementsByTagName("link").length,2,"Correct amount of stylesheets inserted into the dom tree"),start()},{stylesheets:["https://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/themes/blitzer/jquery-ui.css","https://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/themes/excite-bike/jquery-ui.css"]})).insertInto(document.body)}),asyncTest("Check X-UA-Compatible",function(){expect(1),(new wysihtml5.dom.Sandbox(function(e){var t=e.getDocument(),n=t.documentMode;ok(t.documentMode===document.documentMode,"iFrame is in in the same document mode as the parent site"),start()})).insertInto(document.body)});