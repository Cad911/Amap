wysihtml5.browser.supported()&&(module("wysihtml5.Editor",{setup:function(){wysihtml5.dom.insertCSS(["#wysihtml5-test-textarea { width: 200px; height: 100px; margin-top: 5px; font-style: italic; border: 2px solid red; border-radius: 2px; }","#wysihtml5-test-textarea:focus { margin-top: 10px; }"]).into(document),this.textareaElement=document.createElement("textarea"),this.textareaElement.id="wysihtml5-test-textarea",this.textareaElement.title="Please enter your foo",this.textareaElement.value="hey tiff, what's up?",this.form=document.createElement("form"),this.form.onsubmit=function(){return!1},this.form.appendChild(this.textareaElement),this.originalBodyClassName=document.body.className,document.body.appendChild(this.form)},teardown:function(){var e;while(e=document.querySelector("iframe.wysihtml5-sandbox, input[name='_wysihtml5_mode']"))e.parentNode.removeChild(e);this.form.parentNode.removeChild(this.form),document.body.className=this.originalBodyClassName},getComposerElement:function(){return this.getIframeElement().contentWindow.document.body},getIframeElement:function(){var e=document.querySelectorAll("iframe.wysihtml5-sandbox");return e[e.length-1]}}),asyncTest("Basic test",function(){expect(16);var e=this,t=new wysihtml5.Editor(this.textareaElement);t.observe("load",function(){var n=e.getIframeElement(),r=e.getComposerElement(),i=e.textareaElement;ok(!0,"Load callback triggered"),ok(wysihtml5.dom.hasClass(document.body,"wysihtml5-supported"),"<body> received correct class name"),equal(i.style.display,"none","Textarea not visible"),ok(n.style.display,"","Editor iFrame is visible"),equal(t.currentView.name,"composer","Current view is 'composer'"),i.style.display="",deepEqual([n.offsetHeight,n.offsetWidth],[i.offsetHeight,i.offsetWidth],"Editor has the same dimensions as the original textarea"),i.style.display="none";var s=i.nextSibling;equal(s.name,"_wysihtml5_mode","Hidden field has correct name"),equal(s.value,"1","Hidden field has correct value"),equal(s.type,"hidden","Hidden field is actually hidden"),equal(i.nextSibling.nextSibling,n,"Editor iframe is inserted after the textarea"),equal(r.getAttribute("contentEditable"),"true","Body element in iframe is editable"),equal(t.textarea.element,i,"Textarea correctly available on editor instance"),equal(t.composer.element,r,"contentEditable element available on editor instance"),equal(wysihtml5.dom.getStyle("font-style").from(r),"italic","Correct font-style applied to editor element"),"borderRadius"in document.createElement("div").style&&(expect(17),ok(wysihtml5.dom.getStyle("border-top-right-radius").from(n).indexOf("2px")!==-1,"border-radius correctly copied")),equal(r.innerHTML.toLowerCase(),"hey tiff, what's up?","Copied the initial textarea value to the editor"),ok(wysihtml5.dom.hasClass(r,"wysihtml5-editor"),"Editor element has correct class name"),start()})}),asyncTest("Check setting of name as class name on iframe and iframe's body",function(){expect(4),this.textareaElement.className="death-star";var e=this,t="star-wars-input",n=new wysihtml5.Editor(this.textareaElement,{name:"star-wars-input"});n.observe("load",function(){var n=e.getIframeElement(),r=e.getComposerElement(),i=e.textareaElement;ok(wysihtml5.dom.hasClass(n,t),"iFrame has adopted name as className"),ok(wysihtml5.dom.hasClass(r,t),"iFrame's body has adopted name as className"),ok(wysihtml5.dom.hasClass(r,"death-star"),"iFrame's body has adopted the textarea className"),ok(!wysihtml5.dom.hasClass(i,t),"Textarea has not adopted name as className"),start()})}),asyncTest("Check textarea with box-sizing: border-box;",function(){expect(1);var e=this;wysihtml5.dom.setStyles({MozBoxSizing:"border-box",WebkitBoxSizing:"border-box",MsBoxSizing:"border-box",boxSizing:"border-box"}).on(this.textareaElement);var t=new wysihtml5.Editor(this.textareaElement);t.observe("load",function(){e.textareaElement.style.display="",deepEqual([e.getIframeElement().offsetWidth,e.getIframeElement().offsetHeight],[e.textareaElement.offsetWidth,e.textareaElement.offsetHeight],"Editor has the same dimensions as the original textarea"),e.textareaElement.style.display="none",start()})}),asyncTest("Check whether attributes are copied",function(){expect(1);var e=this,t=new wysihtml5.Editor(this.textareaElement);t.observe("load",function(){equal(e.getComposerElement().title,e.textareaElement.title,"Editor got attributes copied over from textarea"),start()})}),asyncTest("Check events",function(){expect(8);var e=this,t=new wysihtml5.Editor(this.textareaElement);t.observe("beforeload",function(){ok(!0,"'beforeload' event correctly fired")}),t.observe("load",function(){var n=e.getComposerElement(),r=e.getIframeElement();t.observe("focus",function(){ok(!0,"'focus' event correctly fired")}),t.observe("blur",function(){ok(!0,"'blur' event correctly fired")}),t.observe("change",function(){ok(!0,"'change' event correctly fired")}),t.observe("paste",function(){ok(!0,"'paste' event correctly fired")}),t.observe("drop",function(){ok(!0,"'drop' event correctly fired")}),t.observe("custom_event",function(){ok(!0,"'custom_event' correctly fired")}),QUnit.triggerEvent(n,"focus"),t.stopObserving("focus"),n.innerHTML="foobar",QUnit.triggerEvent(n,"blur"),QUnit.triggerEvent(n,"focusout"),equal(wysihtml5.dom.getStyle("margin-top").from(r),"5px",":focus styles are correctly unset"),QUnit.triggerEvent(n,"paste"),QUnit.triggerEvent(n,"drop"),t.fire("custom_event"),setTimeout(function(){start()},100)})}),asyncTest("Check sync (basic)",function(){expect(1);var e=this,t=new wysihtml5.Editor(this.textareaElement);t.observe("load",function(){var t="<p>hello foobar, what up?</p>";e.getComposerElement().innerHTML=t,setTimeout(function(){equal(e.textareaElement.value.toLowerCase(),t.toLowerCase(),"Editor content got correctly copied over to original textarea"),start()},500)})}),asyncTest("Check sync (advanced)",function(){expect(5);var e=this,t=new wysihtml5.Editor(this.textareaElement,{parserRules:{tags:{strong:!0}}});t.observe("load",function(){var n="<strong>timmay!</strong>",r=e.getComposerElement();r.innerHTML=n,setTimeout(function(){equal(e.textareaElement.value.toLowerCase(),n.toLowerCase(),"Editor content got correctly copied over to original textarea"),r.innerHTML='<font color="red">hey </font><strong>helen!</strong>',t.fire("change_view","textarea"),equal(e.textareaElement.value.toLowerCase(),"hey <strong>helen!</strong>","Editor got immediately copied over to textarea after switching the view"),e.textareaElement.value="<i>hey </i><strong>richard!</strong>",t.fire("change_view","composer"),equal(r.innerHTML.toLowerCase(),"hey <strong>richard!</strong>","Textarea sanitized and copied over it's value to the editor after switch"),r.innerHTML="<i>hey </i><strong>timmay!</strong>",QUnit.triggerEvent(e.form,"submit"),equal(e.textareaElement.value.toLowerCase(),"hey <strong>timmay!</strong>","Textarea gets the sanitized content of the editor onsubmit"),setTimeout(function(){e.form.reset(),setTimeout(function(){equal(wysihtml5.dom.getTextContent(r),"","Editor is empty after reset"),start()},100)},500)},500)})}),asyncTest("Check placeholder",function(){expect(13);var e=this,t="enter text ...";this.textareaElement.value="",this.textareaElement.setAttribute("placeholder","enter text ...");var n=new wysihtml5.Editor(this.textareaElement);n.observe("load",function(){var r=e.getComposerElement();equal(wysihtml5.dom.getTextContent(r),t,"Placeholder text correctly copied into textarea"),ok(wysihtml5.dom.hasClass(r,"placeholder"),"Editor got 'placeholder' css class"),ok(n.hasPlaceholderSet(),"'hasPlaceholderSet' returns correct value when placeholder is actually set"),n.fire("focus:composer"),equal(wysihtml5.dom.getTextContent(r),"","Editor is empty after focus"),ok(!wysihtml5.dom.hasClass(r,"placeholder"),"Editor hasn't got 'placeholder' css class"),ok(!n.hasPlaceholderSet(),"'hasPlaceholderSet' returns correct value when placeholder isn't actually set"),n.fire("blur:composer"),equal(wysihtml5.dom.getTextContent(r),t,"Editor restored placeholder text after unfocus"),n.fire("focus:composer"),equal(wysihtml5.dom.getTextContent(r),""),r.innerHTML="some content",n.fire("blur:composer"),equal(wysihtml5.dom.getTextContent(r),"some content"),ok(!wysihtml5.dom.hasClass(r,"placeholder"),"Editor hasn't got 'placeholder' css class"),n.fire("focus:composer");var i="<img>";r.innerHTML=i,n.fire("blur:composer"),equal(r.innerHTML.toLowerCase(),i,"HTML hasn't been cleared even though the innerText and textContent properties indicate empty content."),ok(!wysihtml5.dom.hasClass(r,"placeholder"),"Editor hasn't got 'placeholder' css class"),setTimeout(function(){e.form.reset(),setTimeout(function(){equal(wysihtml5.dom.getTextContent(r),t,"After form reset the editor has the placeholder as content"),start()},100)},500)})}),asyncTest("Check public api",function(){expect(14);var e=this,t=new wysihtml5.Editor(this.textareaElement,{parserRules:{tags:{p:{rename_tag:"div"}}},bodyClassName:"editor-is-supported",composerClassName:"editor"});t.observe("load",function(){ok(t.isCompatible(),"isCompatible() returns correct value"),ok(wysihtml5.dom.hasClass(document.body,"editor-is-supported"),"<body> received correct class name");var n=e.getComposerElement();t.clear(),equal(wysihtml5.dom.getTextContent(n),"","Editor empty after calling 'clear'"),ok(wysihtml5.dom.hasClass(n,"editor"),"Composer element has correct class name");var r="hello <strong>foo</strong>!";t.setValue(r),equal(n.innerHTML.toLowerCase(),r,"Editor content correctly set after calling 'setValue'"),ok(!t.isEmpty(),"'isEmpty' returns correct value when the composer element isn't actually empty");var i=t.getValue();equal(i.toLowerCase(),r,"Editor content correctly returned after calling 'getValue'"),t.clear(),i=t.getValue(),equal(i,""),ok(t.isEmpty(),"'isEmpty' returns correct value when the composer element is actually empty"),equal(t.parse("<p>foo</p>").toLowerCase(),"<div>foo</div>","'parse' returns correct value"),t.disable(),ok(!n.getAttribute("contentEditable"),"When disabled the composer hasn't the contentEditable attribute"),equal(n.getAttribute("disabled"),"disabled",'When disabled the composer has the disabled="disabled" attribute'),t.enable(),equal(n.getAttribute("contentEditable"),"true","After enabling the editor the contentEditable property is true"),ok(!n.getAttribute("disabled"),"After enabling the disabled attribute is unset"),start()})}),asyncTest("Parser (default parser method with parserRules as object",function(){expect(2);var e={tags:{div:!0,p:{rename_tag:"div"},span:!0,script:undefined}},t="<p>foobar</p>",n="<div>foobar</div>",r=new wysihtml5.Editor(this.textareaElement,{parserRules:e});r.observe("load",function(){equal(r.config.parserRules,e,"Parser rules correctly set on config object"),r.setValue(t,!0),equal(r.getValue().toLowerCase(),n,"HTML got correctly parsed within setValue()"),start()})}),asyncTest("Parser (custom parser method with parserRules as object",function(){expect(7);var e=this,t={script:undefined},n=this.textareaElement.value,r=n,i=new wysihtml5.Editor(this.textareaElement,{parserRules:t,parser:function(r,i,s){return equal(r.toLowerCase(),n,"HTML passed into parser is equal to the one which just got inserted"),equal(i,t,"Rules passed into parser are equal to those given to the editor"),equal(s,e.getIframeElement().contentWindow.document,"Context passed into parser is equal the document object of the editor's iframe"),r.replace(/\<script\>.*?\<\/script\>/gi,"")}});i.observe("load",function(){n="<p>foobar</p><script>alert(1);</script>",r="<p>foobar</p>",i.setValue(n,!0),equal(i.getValue().toLowerCase(),r,"HTML got correctly parsed within setValue()"),start()})}),asyncTest("Inserting an element which causes the textContent/innerText of the contentEditable element to be empty works correctly",function(){expect(2);var e=this,t=new wysihtml5.Editor(this.textareaElement);t.observe("load",function(){var t="<img>",n=e.getComposerElement(),r=e.textareaElement;n.innerHTML=t,QUnit.triggerEvent(n,"keypress"),QUnit.triggerEvent(n,"keyup"),QUnit.triggerEvent(n,"cut"),QUnit.triggerEvent(n,"blur"),setTimeout(function(){equal(n.innerHTML.toLowerCase(),t,"Composer still has correct content"),equal(r.value.toLowerCase(),t,"Textarea got correct value"),start()},500)})}),asyncTest("Check for stylesheets",function(){expect(5);var e=this,t=["http://yui.yahooapis.com/2.8.2r1/build/reset/reset-min.css","http://yui.yahooapis.com/2.8.0/build/reset/reset-min.css"],n=new wysihtml5.Editor(this.textareaElement,{stylesheets:t});n.observe("load",function(){var n=e.getIframeElement(),r=n.contentWindow.document,i=r.getElementsByTagName("link");equal(i.length,2,"Correct amount of stylesheets inserted into the dom tree"),equal(i[0].getAttribute("href"),t[0]),equal(i[0].getAttribute("rel"),"stylesheet"),equal(i[1].getAttribute("href"),t[1]),equal(i[1].getAttribute("rel"),"stylesheet"),start()})}),asyncTest("Check config.supportTouchDevices = false",function(){expect(2);var e=this,t=wysihtml5.browser.isTouchDevice;wysihtml5.browser.isTouchDevice=function(){return!0};var n=new wysihtml5.Editor(this.textareaElement,{supportTouchDevices:!1});n.observe("load",function(){ok(!e.getIframeElement(),"No editor iframe has been inserted"),equal(e.textareaElement.style.display,"","Textarea is visible"),wysihtml5.browser.isTouchDevice=t,start()})}));